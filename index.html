<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ویدیو + QR (با فالبک تضمینی)</title>

  <!-- استایل ساده -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- کتابخانهٔ QR -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"
          integrity="sha512-CNgI+PvfSaH0YzZp0yDW8s0kL9sZf1R8Q9vuuqUj5hT1o4d7q9gH9B2v3F9zj7+zVQhVYt8NwS1f+7x7YkBv3g=="
          crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <style>
    @media print { #controls{display:none!important} #grid{grid-template-columns:repeat(3,minmax(0,1fr))} }
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  </style>
</head>
<body class="bg-neutral-50 text-neutral-900">
  <header class="sticky top-0 z-10 bg-white/80 backdrop-blur border-b">
    <div id="controls" class="max-w-5xl mx-auto px-4 py-4 flex items-center gap-3">
      <div class="font-bold text-lg">🎬 ویدیو + QR</div>
      <div class="ml-auto">
        <button id="print" class="border rounded px-3 py-2 text-sm hover:bg-neutral-100">پرینت QR</button>
      </div>
    </div>
  </header>

  <main class="max-w-5xl mx-auto px-4 py-8">
    <!-- فرم برای وارد کردن لینک ویدیوی جدید -->
    <div class="mb-6">
      <label for="videoUrl" class="block text-sm font-medium">لینک ویدیوی جدید:</label>
      <input id="videoUrl" type="url" class="mt-1 p-2 border rounded w-full" placeholder="https://example.com/video.mp4">
      <button id="generateQR" class="mt-2 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">تولید QR</button>
    </div>

    <!-- لاگ برای عیب‌یابی -->
    <pre id="log" class="mono text-xs bg-white border rounded p-3 mb-4 whitespace-pre-wrap"></pre>

    <!-- کارت -->
    <div id="card" class="overflow-hidden rounded-2xl shadow-sm bg-white border flex flex-col"></div>
  </main>

  <footer class="border-t bg-white/70">
    <div class="max-w-5xl mx-auto px-4 py-6 text-xs text-neutral-500 flex items-center justify-between">
      <div>© <span id="year"></span></div>
      <button id="copy" class="px-2 py-1 rounded hover:bg-neutral-100">کپی آدرس صفحه</button>
    </div>
  </footer>

  <script>
    // ——— تنظیمات اولیه ———
    const QR_SIZE = 148;
    let VIDEO_URL = "https://navidrahmani94.github.io/music-qr-portfolio/assets/videos/logo%20M.mp4"; // پیش‌فرض

    // ——— کمک‌ها ———
    const logEl = document.getElementById("log");
    function log(...args) { logEl.textContent += args.join(" ") + "\n"; }
    
    function makeQRWithLib(container, text) {
      try {
        if (typeof QRCode === "function") {
          new QRCode(container, { text, width: QR_SIZE, height: QR_SIZE });
          const img = container.querySelector("img");
          if (!img) {
            const canvas = container.querySelector("canvas");
            if (canvas) {
              const i = new Image();
              i.src = canvas.toDataURL("image/png");
              i.width = QR_SIZE; i.height = QR_SIZE;
              i.className = "rounded border";
              container.innerHTML = "";
              container.appendChild(i);
            }
          } else {
            img.width = QR_SIZE; img.height = QR_SIZE;
            img.className = "rounded border";
          }
          return true;
        }
      } catch (e) { log("QR lib error:", e.message); }
      return false;
    }

    function makeQRFallbackIMG(container, text) {
      const url = `https://api.qrserver.com/v1/create-qr-code/?size=${QR_SIZE}x${QR_SIZE}&data=${encodeURIComponent(text)}`;
      const img = new Image();
      img.src = url;
      img.width = QR_SIZE; img.height = QR_SIZE;
      img.alt = "QR";
      img.className = "rounded border";
      container.innerHTML = "";
      container.appendChild(img);
      return img;
    }

    // ——— UI ابتدایی ———
    document.getElementById("year").textContent = new Date().getFullYear();
    document.getElementById("print").onclick = () => window.print();
    document.getElementById("copy").onclick = () => navigator.clipboard.writeText(location.href);

    log("PAGE_URL =", location.href);
    log("VIDEO_URL =", VIDEO_URL);

    // ——— تابع برای به‌روزرسانی کارت ———
    function updateCard(videoUrl) {
      const card = document.getElementById("card");
      card.innerHTML = ""; // پاک کردن محتوای قبلی

      // ——— ویدیو ———
      const media = document.createElement("div");
      const vid = document.createElement("video");
      vid.controls = true;
      vid.preload = "metadata";
      vid.className = "w-full h-60 object-contain bg-black";
      const src = document.createElement("source");
      src.src = videoUrl; src.type = "video/mp4";
      vid.appendChild(src);
      media.appendChild(vid);
      card.appendChild(media);

      // اگر پخش خطا داشت، پیام بده
      vid.addEventListener("error", () => {
        const err = vid.error, map = {1:"ABORTED",2:"NETWORK",3:"DECODE",4:"SRC_NOT_SUPPORTED"};
        const code = err?.code || 0;
        log("VIDEO_ERROR code=" + code + " (" + (map[code]||"UNKNOWN") + ")");
        const warn = document.createElement("div");
        warn.className = "p-3 mt-2 text-sm rounded bg-red-50 border text-red-700";
        warn.textContent = "پخش ویدیو خطا داد: code=" + code + " (" + (map[code]||"UNKNOWN") + ") — اگر 404 است مسیر/نام فایل را چک کن؛ اگر DECODE است فایل را به H.264/AAC تبدیل کن.";
        media.appendChild(warn);
      });

      // ——— بدنه + QR ———
      const body = document.createElement("div");
      body.className = "p-4";
      body.innerHTML = `
        <div class="font-semibold text-base">ویدیو</div>
        <div class="mt-2 text-xs text-neutral-600 break-all">
          لینک مستقیم: <a class="underline text-blue-600" href="${videoUrl}" target="_blank" rel="noreferrer">${videoUrl}</a>
        </div>
      `;
      const row = document.createElement("div");
      row.className = "mt-4 flex items-center gap-3";

      const qrBox = document.createElement("div");
      qrBox.id = "qrBox";
      row.appendChild(qrBox);

      const actions = document.createElement("div");
      actions.className = "flex flex-col gap-2";
      const open = document.createElement("a");
      open.className = "px-3 py-2 rounded bg-black text-white text-sm hover:opacity-90 inline-block";
      open.href = videoUrl; open.target = "_blank"; open.rel = "noreferrer"; open.textContent = "Open";
      const copyBtn = document.createElement("button");
      copyBtn.className = "px-3 py-2 rounded border text-sm hover:bg-neutral-100";
      copyBtn.textContent = "Copy Link";
      copyBtn.onclick = () => navigator.clipboard.writeText(videoUrl);
      const dl = document.createElement("a");
      dl.className = "px-3 py-2 rounded border text-sm hover:bg-neutral-100 inline-block";
      dl.textContent = "Download QR";
      dl.id = "dlQR";
      actions.append(open, copyBtn, dl);
      row.appendChild(actions);

      body.appendChild(row);
      card.appendChild(body);

      // ——— ساخت QR ———
      let qrImgElement = null;
      const ok = makeQRWithLib(qrBox, videoUrl);
      if (ok) {
        log("QR: ساخته شد با qrcodejs");
        qrImgElement = qrBox.querySelector("img") || qrBox.querySelector("canvas");
      } else {
        log("QR: فالبک آنلاین (img) فعال شد");
        qrImgElement = makeQRFallbackIMG(qrBox, videoUrl);
      }

      // لینک دانلود QR
      const dlLink = document.getElementById("dlQR");
      if (qrImgElement.tagName.toLowerCase() === "img" && qrImgElement.src.startsWith("data:")) {
        dlLink.href = qrImgElement.src;
      } else {
        dlLink.href = qrImgElement.src || videoUrl;
      }
      dlLink.download = "video-qr.png";
    }

    // ——— رویداد برای فرم ———
    document.getElementById("generateQR").onclick = () => {
      const videoUrlInput = document.getElementById("videoUrl").value;
      if (videoUrlInput) {
        VIDEO_URL = videoUrlInput;
        log("NEW_VIDEO_URL =", VIDEO_URL);
        updateCard(VIDEO_URL);
      } else {
        log("لطفاً لینک ویدیوی معتبر وارد کنید.");
      }
    };

    // ——— بارگذاری اولیه ———
    updateCard(VIDEO_URL);
  </script>
</body>
</html>
